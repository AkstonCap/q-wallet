<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nexus dApp Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #0066ff;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      background: #f8f9fa;
      border-left: 4px solid #0066ff;
    }
    .status.connected {
      background: #d4edda;
      border-left-color: #28a745;
    }
    .status.error {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    button {
      background: #0066ff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      transition: background 0.2s;
    }
    button:hover {
      background: #0052cc;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }
    .section h3 {
      margin-top: 0;
      color: #333;
    }
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      margin: 8px 0;
      box-sizing: border-box;
    }
    .info-item {
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      word-break: break-all;
    }
    .label {
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
    }
    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 13px;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Nexus dApp Example</h1>
    <p class="subtitle">Test your Nexus Wallet browser extension integration</p>

    <div id="wallet-status" class="status">
      Wallet Status: <span id="status-text">Checking...</span>
    </div>

    <div class="warning">
      ⚠️ <strong>Security Features:</strong>
      <ul style="margin: 10px 0 0 20px;">
        <li>First connection requires explicit approval via notification</li>
        <li>Only approved sites can access wallet functions</li>
        <li>Manage connected sites in Settings → Connected Sites</li>
        <li>Revoke access anytime from the wallet settings</li>
      </ul>
    </div>

    <!-- Connection Section -->
    <div class="section">
      <h3>1. Connect Wallet</h3>
      <button id="connect-btn" onclick="connectWallet()">Connect Wallet</button>
      <button id="check-btn" onclick="checkConnection()">Check Connection</button>
      <button id="disconnect-btn" onclick="disconnectWallet()" style="display: none; background: #dc3545;">Disconnect Wallet</button>
      
      <div id="account-info" style="display: none;">
        <div class="label">Connected Account:</div>
        <div class="info-item" id="account-address"></div>
      </div>
    </div>

    <!-- Balance Section -->
    <div class="section">
      <h3>2. Get Balance</h3>
      <button id="balance-btn" onclick="getBalance()" disabled>Get Balance</button>
      
      <div id="balance-info" style="display: none;">
        <div class="label">Balance:</div>
        <div class="info-item" id="balance-amount"></div>
      </div>
    </div>

    <!-- Send Transaction Section -->
    <div class="section">
      <h3>3. Send Transaction</h3>
      <input type="text" id="send-to" placeholder="Recipient address or username">
      <input type="number" id="send-amount" placeholder="Amount (NXS)" step="0.01" min="0">
      <input type="text" id="send-reference" placeholder="Reference (optional)">
      <button id="send-btn" onclick="sendTransaction()" disabled>Send Transaction</button>
      
      <div id="tx-result" style="display: none;">
        <div class="label">Transaction Result:</div>
        <div class="info-item" id="tx-data"></div>
      </div>
    </div>

    <!-- Transaction History Section -->
    <div class="section">
      <h3>4. Transaction History</h3>
      <button id="history-btn" onclick="getHistory()" disabled>Get Transaction History</button>
      
      <div id="history-info" style="display: none;">
        <div class="label">Recent Transactions:</div>
        <div id="history-list"></div>
      </div>
    </div>

    <!-- Batch Transaction Section -->
    <div class="section">
      <h3>5. Batch Transactions (Multiple Orders)</h3>
      <p style="color: #666; font-size: 14px;">Execute multiple transactions with a single PIN approval. Perfect for market orders, bulk payments, etc.</p>
      
      <div style="margin: 15px 0;">
        <div class="label">Transaction 1:</div>
        <input type="text" id="batch-to-1" placeholder="Recipient 1 address">
        <input type="number" id="batch-amount-1" placeholder="Amount 1" step="0.01" min="0" value="1.5">
        <input type="text" id="batch-ref-1" placeholder="Reference 1 (optional)" value="Order #1">
      </div>
      
      <div style="margin: 15px 0;">
        <div class="label">Transaction 2:</div>
        <input type="text" id="batch-to-2" placeholder="Recipient 2 address">
        <input type="number" id="batch-amount-2" placeholder="Amount 2" step="0.01" min="0" value="2.5">
        <input type="text" id="batch-ref-2" placeholder="Reference 2 (optional)" value="Order #2">
      </div>
      
      <div style="margin: 15px 0;">
        <div class="label">Transaction 3:</div>
        <input type="text" id="batch-to-3" placeholder="Recipient 3 address">
        <input type="number" id="batch-amount-3" placeholder="Amount 3" step="0.01" min="0" value="0.75">
        <input type="text" id="batch-ref-3" placeholder="Reference 3 (optional)" value="Order #3">
      </div>
      
      <button id="batch-send-btn" onclick="sendBatchTransactions()" disabled style="background: #ff6600;">Send Batch (3 Transactions)</button>
      
      <div id="batch-result" style="display: none;">
        <div class="label">Batch Result:</div>
        <div class="info-item" id="batch-data"></div>
      </div>
    </div>

    <!-- Section 6: Batch API Calls -->
    <div class="section">
      <h2>6. Batch API Calls (Multiple Operations)</h2>
      <p>Execute multiple different API operations with a single approval. Supports up to 12 API calls per batch.</p>
      
      <div class="form-group">
        <div class="label">Example: Market Orders + Finance Debit</div>
        <p style="font-size: 14px; color: #666; margin-bottom: 12px;">
          This example will execute 4 API calls:
          <br>• market/execute/order (Order 1)
          <br>• market/execute/order (Order 2)
          <br>• market/create/bid
          <br>• finance/debit/account (Fee payment)
        </p>
      </div>
      
      <button id="batch-calls-btn" onclick="executeBatchCalls()" disabled style="background: #9c27b0;">Execute Batch API Calls</button>
      
      <div id="batch-calls-result" style="display: none;">
        <div class="label">Batch Calls Result:</div>
        <div class="info-item" id="batch-calls-data"></div>
      </div>

      <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-top: 16px; font-size: 13px;">
        <strong>ℹ️ Fees:</strong>
        <br>• DIST Service: 1 NXS (1-4 calls), 2 NXS (5-8 calls), 3 NXS (9-12 calls)
        <br>• Nexus Network: 0.01 NXS per call (within 10 seconds of first call)
      </div>
    </div>

    <!-- Code Example -->
    <div class="section">
      <h3>Developer Reference</h3>
      <p>Example code to integrate Nexus Wallet in your dApp:</p>
      <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto;"><code>// Check if wallet is available
if (typeof window.nexus !== 'undefined') {
  // Connect to wallet
  const accounts = await window.nexus.connect();
  console.log('Connected:', accounts[0]);
  
  // Get balance
  const balance = await window.nexus.getBalance();
  console.log('Balance:', balance);
  
  // Send single transaction
  const tx = await window.nexus.sendTransaction({
    to: 'recipient-address',
    amount: 10.5,
    reference: 'Payment'
  });
  console.log('Transaction:', tx);
  
  // Send batch transactions (NEW!)
  const batchResult = await window.nexus.sendBatchTransactions([
    { to: 'address1', amount: 5.0, reference: 1 },
    { to: 'address2', amount: 3.5, reference: 2 },
    { to: 'address3', amount: 1.5, reference: 3 }
  ]);
  console.log('Batch result:', batchResult);
  
  // Execute batch API calls (NEW!)
  const batchCallsResult = await window.nexus.executeBatchCalls([
    { endpoint: 'market/execute/order', params: { txid: '0123...abcdef', from: 'default', to: 'default' } },
    { endpoint: 'market/execute/order', params: { txid: 'fedc...987654', from: 'default', to: 'default' } },
    { endpoint: 'market/create/bid', params: { market: 'NXS/USD', amount: 10, price: 1.5, from: 'default', to: 'usd' } },
    { endpoint: 'finance/debit/account', params: { from: 'default', to: 'fee-address', amount: 0.1 } }
  ]);
  console.log('Batch calls result:', batchCallsResult);
}</code></pre>
    </div>
  </div>

  <script>
    let connectedAccount = null;

    // Check if Nexus Wallet is installed
    async function checkWalletInstalled() {
      if (typeof window.nexus === 'undefined') {
        updateStatus('Nexus Wallet not detected! Please install the extension.', 'error');
        return false;
      }
      updateStatus('Nexus Wallet detected!', 'connected');
      return true;
    }

    // Connect to wallet
    async function connectWallet() {
      try {
        if (!await checkWalletInstalled()) return;

        updateStatus('Connecting to wallet...', '');
        const accounts = await window.nexus.connect();
        
        if (accounts && accounts.length > 0) {
          connectedAccount = accounts[0];
          updateStatus('Connected to wallet!', 'connected');
          document.getElementById('account-address').textContent = connectedAccount;
          document.getElementById('account-info').style.display = 'block';
          
          // Show disconnect button, hide connect button
          document.getElementById('connect-btn').style.display = 'none';
          document.getElementById('disconnect-btn').style.display = 'inline-block';
          
          // Enable buttons
          document.getElementById('balance-btn').disabled = false;
          document.getElementById('send-btn').disabled = false;
          document.getElementById('history-btn').disabled = false;
          document.getElementById('batch-send-btn').disabled = false;
        } else {
          updateStatus('No accounts found. Please log in to your wallet.', 'error');
        }
      } catch (error) {
        console.error('Connection failed:', error);
        updateStatus('Connection failed: ' + error.message, 'error');
      }
    }

    // Disconnect wallet
    // Disconnect from wallet
    async function disconnectWallet() {
      try {
        if (!await checkWalletInstalled()) return;

        updateStatus('Disconnecting...', '');
        
        // Call wallet disconnect method
        await window.nexus.disconnect();
        
        connectedAccount = null;
        
        // Update UI
        updateStatus('Wallet disconnected successfully!', '');
        
        // Hide all info sections (with null checks)
        const elementsToHide = [
          'account-info', 'balance-info', 'tx-result', 
          'history-info', 'batch-result', 'batch-calls-result'
        ];
        elementsToHide.forEach(id => {
          const element = document.getElementById(id);
          if (element) element.style.display = 'none';
        });
        
        // Show connect button, hide disconnect button
        document.getElementById('connect-btn').style.display = 'inline-block';
        document.getElementById('disconnect-btn').style.display = 'none';
        
        // Disable buttons
        const buttonsToDisable = [
          'balance-btn', 'send-btn', 'history-btn', 
          'batch-send-btn', 'batch-calls-btn'
        ];
        buttonsToDisable.forEach(id => {
          const button = document.getElementById(id);
          if (button) button.disabled = true;
        });
        
        alert('Successfully disconnected from Q-Wallet!');
      } catch (error) {
        console.error('Disconnect failed:', error);
        updateStatus('Disconnect failed: ' + error.message, 'error');
      }
    }

    // Check connection status
    async function checkConnection() {
      try {
        if (!await checkWalletInstalled()) return;

        const isConnected = await window.nexus.isWalletConnected();
        if (isConnected) {
          const accounts = await window.nexus.getAccounts();
          connectedAccount = accounts[0];
          updateStatus('Wallet is connected!', 'connected');
          document.getElementById('account-address').textContent = connectedAccount;
          document.getElementById('account-info').style.display = 'block';
          
          // Show disconnect button, hide connect button
          document.getElementById('connect-btn').style.display = 'none';
          document.getElementById('disconnect-btn').style.display = 'inline-block';
          
          // Enable buttons
          document.getElementById('balance-btn').disabled = false;
          document.getElementById('send-btn').disabled = false;
          document.getElementById('history-btn').disabled = false;
          document.getElementById('batch-send-btn').disabled = false;
          document.getElementById('batch-calls-btn').disabled = false;
        } else {
          updateStatus('Wallet not connected. Click "Connect Wallet" button.', '');
          
          // Show connect button, hide disconnect button
          document.getElementById('connect-btn').style.display = 'inline-block';
          document.getElementById('disconnect-btn').style.display = 'none';
        }
      } catch (error) {
        console.error('Check failed:', error);
        updateStatus('Check failed: ' + error.message, 'error');
      }
    }

    // Get balance
    async function getBalance() {
      try {
        const balance = await window.nexus.getBalance();
        document.getElementById('balance-amount').textContent = 
          `${balance.balance} ${balance.token || 'NXS'}`;
        document.getElementById('balance-info').style.display = 'block';
        updateStatus('Balance retrieved successfully!', 'connected');
      } catch (error) {
        console.error('Get balance failed:', error);
        updateStatus('Failed to get balance: ' + error.message, 'error');
      }
    }

    // Send transaction
    async function sendTransaction() {
      try {
        const to = document.getElementById('send-to').value.trim();
        const amount = parseFloat(document.getElementById('send-amount').value);
        const reference = document.getElementById('send-reference').value.trim();

        if (!to || !amount) {
          alert('Please enter recipient and amount');
          return;
        }

        updateStatus('Sending transaction...', '');
        
        // Build transaction object, omitting reference if empty
        const txParams = {
          to: to,
          amount: amount
        };
        
        if (reference) {
          txParams.reference = reference;
        }
        
        const result = await window.nexus.sendTransaction(txParams);

        document.getElementById('tx-data').textContent = JSON.stringify(result, null, 2);
        document.getElementById('tx-result').style.display = 'block';
        updateStatus('Transaction sent successfully!', 'connected');

        // Clear form
        document.getElementById('send-to').value = '';
        document.getElementById('send-amount').value = '';
        document.getElementById('send-reference').value = '';
      } catch (error) {
        console.error('Send transaction failed:', error);
        updateStatus('Transaction failed: ' + error.message, 'error');
      }
    }

    // Get transaction history
    async function getHistory() {
      try {
        const transactions = await window.nexus.getTransactionHistory(10);
        const historyList = document.getElementById('history-list');
        
        if (!transactions || transactions.length === 0) {
          historyList.innerHTML = '<div class="info-item">No transactions found</div>';
        } else {
          historyList.innerHTML = transactions.map(tx => 
            `<div class="info-item">
              ${tx.type || 'Transaction'} - ${tx.amount || 0} NXS
              <br><small>${new Date(tx.timestamp * 1000).toLocaleString()}</small>
            </div>`
          ).join('');
        }
        
        document.getElementById('history-info').style.display = 'block';
        updateStatus('Transaction history retrieved!', 'connected');
      } catch (error) {
        console.error('Get history failed:', error);
        updateStatus('Failed to get history: ' + error.message, 'error');
      }
    }

    // Send batch transactions
    async function sendBatchTransactions() {
      try {
        // Collect all transactions
        const transactions = [];
        
        for (let i = 1; i <= 3; i++) {
          const to = document.getElementById(`batch-to-${i}`).value.trim();
          const amount = parseFloat(document.getElementById(`batch-amount-${i}`).value);
          const reference = document.getElementById(`batch-ref-${i}`).value.trim();
          
          if (to && amount && amount > 0) {
            // Build transaction object, omitting reference if empty
            const tx = {
              to: to,
              amount: amount
            };
            
            if (reference) {
              tx.reference = reference;
            }
            
            transactions.push(tx);
          }
        }
        
        if (transactions.length === 0) {
          alert('Please enter at least one transaction with recipient and amount');
          return;
        }
        
        updateStatus(`Sending batch of ${transactions.length} transactions...`, '');
        
        const result = await window.nexus.sendBatchTransactions(transactions);
        
        document.getElementById('batch-data').textContent = JSON.stringify(result, null, 2);
        document.getElementById('batch-result').style.display = 'block';
        updateStatus(`Batch transaction successful! ${result.successfulTransactions}/${result.totalTransactions} completed.`, 'connected');
        
        // Clear form
        for (let i = 1; i <= 3; i++) {
          document.getElementById(`batch-to-${i}`).value = '';
          document.getElementById(`batch-amount-${i}`).value = '';
          document.getElementById(`batch-ref-${i}`).value = '';
        }
      } catch (error) {
        console.error('Batch transaction failed:', error);
        updateStatus('Batch transaction failed: ' + error.message, 'error');
      }
    }

    // Execute batch API calls
    async function executeBatchCalls() {
      try {
        updateStatus('Executing batch API calls...', '');
        
        // Example batch: market orders + finance debit
        const calls = [
          {
            endpoint: 'market/execute/order',
            params: {
              txid: '0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef',
              from: 'default',
              to: 'account2'
              // Note: This is just an example - you'd need a real order txid
            }
          },
          {
            endpoint: 'market/execute/order',
            params: {
              txid: 'fedcba9876543210fedcba9876543210fedcba9876543210fedcba9876543210',
              from: 'default',
              to: 'account2'
            }
          },
          {
            endpoint: 'market/create/bid',
            params: {
              market: 'NXS/USD',
              amount: 10.0,
              price: 1.50,
              from: 'default',
              to: 'account2'
            }
          },
          {
            endpoint: 'finance/debit/account',
            params: {
              from: 'default',
              to: '8Csmb3RP227N1NHJDH8QZRjZjobe4udaygp7aNv5VLPWDvLDVD7',
              amount: 0.5
            }
          }
        ];
        
        const result = await window.nexus.executeBatchCalls(calls);
        
        document.getElementById('batch-calls-data').textContent = JSON.stringify(result, null, 2);
        document.getElementById('batch-calls-result').style.display = 'block';
        updateStatus(`Batch calls successful! ${result.successfulCalls}/${result.totalCalls} completed. DIST fee: ${result.distFee} NXS`, 'connected');
      } catch (error) {
        console.error('Batch calls failed:', error);
        updateStatus('Batch calls failed: ' + error.message, 'error');
      }
    }

    // Update status message
    function updateStatus(message, type) {
      const statusDiv = document.getElementById('wallet-status');
      const statusText = document.getElementById('status-text');
      
      statusText.textContent = message;
      statusDiv.className = 'status ' + type;
    }

    // Check on page load
    window.addEventListener('load', async () => {
      await checkWalletInstalled();
      
      // Listen for wallet provider initialization
      window.addEventListener('nexus#initialized', () => {
        console.log('Nexus provider initialized');
        checkWalletInstalled();
      });
    });
  </script>
</body>
</html>
